<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="moyeora.myapp.dao.PostDao">
  <resultMap id="PostMap" type="Post">
    <id column="post_no" property="no"/>
    <result column="school_no" property="schoolNo"/>
    <result column="user_no" property="userNo"/>
    <result column="category_no" property="categoryNo"/>
    <result column="content" property="content"/>
    <result column="created_at" property="createdAt"/>
    <result column="like_count" property="likeCount"/>
    <result column="comment_count" property="commentCount"/>

    <association property="Writer" javaType="User">
      <id column="user_no" property="no"/>
      <result column="name" property="name"/>
    </association>

    <association property="School" javaType="School">
      <id column="school_no" property="no"/>
      <result column="school_name" property="name"/>
      <result column="school_photo" property="photo"/>
    </association>

    <collection property="FileList" ofType="AttachedFile">
      <id column="file_no" property="no"/>
      <result column="path" property="path"/>
      <result column="name" property="name"/>
      <result column="post_no" property="postNo"/>
    </collection>
  </resultMap>

  <select id="findByLike" resultMap="PostMap" parameterType="int">
    SELECT
      u.user_no,
      u.name AS user_name,
      p.post_no,
      s.school_no,
      p.created_at,
      (select count(*) from likes as l where l.post_no=p.post_no) as like_count,
      (select count(*) from comments as c where c.post_no=p.post_no) as comment_count,
      s.name AS school_name,
      s.photo AS school_photo,
      p.content AS post_content,
      f.path,
      f.name,
      f.post_no
    FROM
      posts p
    INNER JOIN schools s ON s.school_no = p.school_no
    INNER JOIN users u ON p.user_no = u.user_no
    LEFT OUTER JOIN files f ON p.post_no = f.post_no
    order by like_count desc;

  </select>
  <select id="findByFollow" resultMap="PostMap" parameterType="int">
    SELECT
      u.user_no,
      u.name AS user_name,
      p.post_no,
      s.school_no,
      p.created_at,
      (select count(*) from likes as l where l.post_no=p.post_no) as like_count,
      (select count(*) from comments as c where c.post_no=p.post_no) as comment_count,
      s.name AS school_name,
      s.photo AS school_photo,
      p.content AS post_content,
      f.path,
      f.name,
      f.post_no
    FROM
      posts p
      INNER JOIN schools s ON s.school_no = p.school_no
      INNER JOIN users u ON p.user_no = u.user_no
      INNER JOIN follows fo ON fo.follower_user_no = u.user_no
      LEFT OUTER JOIN files f ON p.post_no = f.post_no
    where fo.following_user_no=#{no};

  </select>
  <select id="findByUser" resultMap="PostMap" parameterType="int">
    SELECT
      u.user_no,
      u.name AS user_name,
      p.post_no,
      s.school_no,
      p.created_at,
      (select count(*) from likes as l where l.post_no=p.post_no) as like_count,
      (select count(*) from comments as c where c.post_no=p.post_no) as comment_count,
      s.name AS school_name,
      s.photo AS school_photo,
      p.content AS post_content,
      f.path,
      f.name,
      f.post_no
    FROM
      posts p
    INNER JOIN schools s ON s.school_no = p.school_no
    INNER JOIN users u ON p.user_no = u.user_no
    LEFT OUTER JOIN files f ON p.post_no = f.post_no
    where p.user_no=#{no}
    order by p.created_at desc;
  </select>
</mapper>

<!--  <collection property="fileList" ofType="AttachedFile">-->
<!--    <id column="file_no" property="no"/>-->
<!--    <result column="file_path" property="filePath"/>-->
<!--    <result column="post_no" property="postNo"/>-->
<!--  </collection>-->
