<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!-- include libraries(jQuery, bootstrap) -->
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

		<!-- include summernote css/js -->
		<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>

		<!-- 공통 헤더 적용 첨부 -->
		<link rel="stylesheet" href="/static/admin/css/header.css"/>
		<link rel="preconnect" href="https://fonts.googleapis.com"/>
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
		<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
		      rel="stylesheet">

		<title>스쿨 메인페이지</title>

		<script src="https://kit.fontawesome.com/ee5cb5f44c.js" crossorigin="anonymous"></script>
</head>

<body>

<div data-th-replace="header :: header"></div>

<h1>스쿨 회원 리스트</h1>

<table class="table table-bordered">
		<thread>
				<tr>
						<th>회원명</th>
						<th>프로필 사진</th>
						<th>회원 등급</th>
				</tr>
		</thread>

		<tbody>
		<tr data-th-each="schoolUser : ${schoolUsers}" data-th-object="${schoolUser}">
				<td data-th-text="*{writer.nickname}">작성자</td>
				<td data-th-text="*{writer.photo}">사진</td>
				<td data-th-text="*{level.levelName}">회원 등급</td>
		</tr>
		</tbody>
</table>

<br/>
<br/>

<h1>스쿨 게시글 리스트</h1>
<!-- 검색창-->
<form action="/post/search" method="post">
		<div>
				<select name="filter">
						<option value="0">내용</option>
						<option value="1">작성자</option>
				</select>
				<input name="keyword" type="text" placeholder="검색어를 입력하세요."/>
				<input name="schoolNo" type="hidden" value="1"/><!-- schoolNo를 Integer로 선언 -->
				<button id="postSearchForm">검색</button>
		</div>
</form>

<div id="searchResult">
		<!-- 검색 결과가 여기에 표시될 것입니다 -->
</div>


<!-- 모달 버튼 -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newPostModal">
		새 글 작성
</button>

<!-- 새 글 모달 -->
<div class="modal fade" id="newPostModal" tabindex="-1" role="dialog" aria-labelledby="newPostModalLabel"
     aria-hidden="true">
		<div class="modal-dialog" role="document">
				<div class="modal-content">
						<div class="modal-header">
								<h5 class="modal-title" id="newPostModalLabel">새 글 작성</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
								</button>
						</div>
						<div class="modal-body">
								<!-- form.html의 내용 -->
								<form action="add" data-th-action="@{add}" enctype='multipart/form-data' method='post'>
										<!-- schoolNo의 값을 넘기기 위해 히든으로 설정 -->
										<input type="hidden" name="schoolNo" value="1"> <!-- 로그인 구현이 안되어있어서 임의로 적용 -->
										<input type="hidden" name="no" value="1"> <!-- 로그인 구현이 안되어있어서 임의로 적용 -->
										<div>
												<!-- Summernote 에디터 -->
												<textarea id="summernote" name='content'></textarea>
										</div>

										<div>
												<!-- 공지로 등록하는 체크박스 -->
												<!-- gradeMd = 체크박스는 관리자만 보이게 설정 -->
												<!-- gradeMdLabel = 공지로등록이라는 텍스트는 관리자만 보이게 설정 -->
												<label for="gradeMd" id="add_gradeMdLabel" style="display: none;">공지로 등록</label>
												<input type="checkbox" id="add_gradeMd" name="post" value="1" style="display: none;">
												<button type="button" id="btn_submit">등록</button>
										</div>
								</form>
						</div>
				</div>
		</div>
</div>


<script>
		$(document).ready(function () {
				$('#summernote').summernote({
						height: 300,
						width: 500,
						callbacks: {
								onInit: function() {
										console.log('Summernote 생성됨!');
								},
								onImageUpload: function(files) {

										let data = new FormData();
										for (const file of files) {
												data.append("files", file);
										}
										$.ajax({
												url: 'file/upload', // 절대경로: http://localhost:8888/board2/file/upload
												type: 'POST',
												dataType: 'json',
												contentType: false,
												processData: false,
												data: data
										})
												.done(function(result) {
												if (result.length == 0) {
														alert('로그인 하세요!');
														return;
												}

												// 서버에서 받은 업로드 파일 이름을 가지고 <img> 태그를 설정한다.
												for (const attachedFile of result) {
														$('#summernote').summernote('insertImage',
																'https://kr.object.ncloudstorage.com/moyeorastorage/post/'
																+ attachedFile.filePath);
												}
										});

								}
						}
				});


		});

</script>
<script>
		$(document).ready(function() {
				// "등록" 버튼 클릭 시 폼 제출 처리
				$("#btn_submit").click(function() {
						// 모달 내의 폼 데이터를 가져옵니다.
						var formData = new FormData($("#newPostModal form")[0]);

						// AJAX를 사용하여 폼 데이터를 서버로 제출합니다.
						$.ajax({
								type: "POST", // POST 요청
								url: "add",   // 데이터를 제출할 URL
								data: formData, // 폼 데이터
								contentType: false, // 컨텐츠 타입을 false로 설정하여 기본값을 사용합니다.
								processData: false, // processData를 false로 설정하여 데이터를 자동 처리하지 않도록 합니다.

								// 요청이 성공하면 수행할 작업을 정의합니다.
								success: function(response) {
										// 필요한 경우 성공 메시지를 표시합니다.
										alert('게시글이 등록되었습니다.');
										// 모달을 닫습니다.
										$("#newPostModal").modal("hide");
								},
								// 요청이 실패하면 수행할 작업을 정의합니다.
								error: function(xhr, status, error) {
										// 필요한 경우 실패 메시지를 표시합니다.
										alert('게시글 등록에 실패했습니다.');
								}
						});
				});
		});
</script>


<table class="table table-bordered">
		<thread>
				<tr>
						<th>닉네임</th>
						<th>사진</th>
						<th>내용</th>
						<th>작성일</th>
						<th>...(설정)</th>
				</tr>
		</thread>
		<tbody>
		<tr data-th-each="post : ${postList}" data-th-object="${post}">
				<td data-th-text="*{writer.nickname}">닉네임</td>
				<td data-th-text="*{writer.photo}">사진</td>
				<td>
						<a data-th-href="@{'view/' + *{schoolNo}(no=*{no})}" th:utext="*{content}">내용</a>
				</td>
				<td data-th-text="${#dates.format(post.createdAt,'yyyy-MM-dd')}">작성일</td>

				<td>
						<div class="dropdown">
								<button class="btn btn-secondary settingBtn" type="button" data-bs-toggle="dropdown"
								        aria-expanded="false">...
								</button>

								<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
										<div>
												<a id="md" class="dropdown-item">글 수정</a>
										</div>

										<div>
												<a id="delete" data-th-href="@{delete(schoolNo=*{schoolNo}, post_no=${post.no})}"
												   class="dropdown-item">삭제</a>
										</div>

										<div>
												<a id="copyLinkButton" class="dropdown-item">주소 복사</a>
										</div>
										<div>
												<a id="report" class="dropdown-item">게시글 신고</a>
										</div>
										<div>
												<label for="gradeMd" id="gradeMdLabel" style="display: none">공지로 등록</label>
												<input type="checkbox" id="gradeMd" name="post" value="1" style="display: none"/>
										</div>
								</div>
						</div>
				</td>
		</tr>
		</tbody>
</table>

<!-- 설정을 눌렀을 때 드롭다운이 나타나도록 -->
<script>
		$(document).ready(function() {
				// ... 버튼을 클릭할 때 드롭다운 메뉴의 가시성을 토글합니다.
				$(".settingBtn").click(function() {
						$(this).next(".dropdown-menu").toggle();
				});
		});
</script>

<script>
		$(document).ready(function() {
				// 모든 드롭다운 메뉴를 숨깁니다.
				$(".dropdown-menu").hide();

				// 클래스를 가진 settingBtn 버튼을 클릭할 때 드롭다운 메뉴의 가시성을 토글합니다.
				$(".settingBtn").click(function() {
						// 모든 드롭다운 메뉴를 숨깁니다.
						$(".dropdown-menu").hide();

						// 클릭된 버튼 다음에 오는 드롭다운 메뉴를 찾아 가시성을 토글합니다.
						$(this).next(".dropdown-menu").toggle();

						// 클릭된 버튼 이외의 부분을 클릭할 때 드롭다운 메뉴를 숨깁니다.
						$(document).on("click", function(event){
								if(!$(event.target).closest(".dropdown").length) {
										$(".dropdown-menu").hide();
								}
						});
				});
		});
</script>


<!--스쿨에 가입하지 않은 유저 가입하기 처리-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.12.1/qs.min.js"
        integrity="sha512-vuLOE4Fh9lfxaN9n81Vl1HwrqMYz9WKoNmsHNC7Hz7OWX4k4O7FjCyQ1tQ82RJExao+Fas40RLiS5PCfVRGgnQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
		// 문서가 로드되면 실행될 함수
		$(document).ready(function() {
				$("#joinButton").click(function() {
						const searchParam = window.location.search.replace("?", "");
						const { schoolNo } = window.Qs.parse(searchParam);
						join(schoolNo);
				});
		});

		function join(schoolNo) {
				$.ajax({
						type: "POST",
						url: "/user/userNo",
						success: function(response) {
								const loginUser = response.no;
								if (!loginUser) {
										console.error("로그인한 사용자 정보가 없습니다.");
										return;
								}
								const userNo = loginUser.no;
								console.log("@@@@@@@==>" + userNo);
								addSchoolUser(userNo, schoolNo);
						},
						error: function(xhr, status, error) {
								console.error("사용자 정보 요청 실패:", error);
								alert("사용자 정보를 가져오지 못했습니다. 다시 시도해주세요.");
						},
				});
		}

		function addSchoolUser(userNo, schoolNo) {
				$.ajax({
						type: "POST",
						url: "/schoolUser/addSchoolUser",
						contentType: "application/json",
						data: JSON.stringify({
								userNo: userNo,
								schoolNo: schoolNo,
						}),
						success: function(response) {
								alert("가입이 완료되었습니다.");
								console.log("사용자 가입 성공");
						},
						error: function(xhr, status, error) {
								alert("가입에 실패했습니다. 다시 시도해 주세요.");
								console.error("가입 요청 실패:", error);
						},
				});
		}
</script>

<!-- 게시글 주소 복사 버튼 -->
<script>
		$(document).ready(function() {
				$('#copyLinkButton').click(function() {
						var url = window.location.href;
						var tempInput = document.createElement('input');
						tempInput.value = url;
						document.body.appendChild(tempInput);
						tempInput.select();
						document.execCommand('copy');
						document.body.removeChild(tempInput);
						alert('게시글 주소가 복사되었습니다.');
				});
		});
</script>

<!-- 폼 서브밋 -->
<script>
		$(document).ready(function() {
				$("#postSearchForm").submit(function(event) {
						event.preventDefault();
						var content = $("input[name='keyword']").val();
						var filter = $("select[name='filter']").val();
						var schoolNo = $("input[name='schoolNo']").val();
						$.ajax({
								type: "GET",
								url: "/post/search",
								data: {
										schoolNo: schoolNo,
										keyword: content,
										filter: filter
								},
								success: function(response) {
										$("#searchResult").html(response);
								},
								error: function(xhr, status, error) {
										console.error("검색 요청 실패:", error);
								}
						});
				});
		});
</script>

</body>

</html>
