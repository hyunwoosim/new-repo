<!DOCTYPE html>
<html lang="en">
<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!--새 글쓰기 모달 참조-->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
		      integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg=="
		      crossorigin="anonymous" referrerpolicy="no-referrer"/>
		<script type="text/javascript"
		        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=62ae4a410f33ef883e67c3c603a063ed&libraries=services"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"
		        integrity="sha512-ykZ1QQr0Jy/4ZkvKuqWn4iF3lqPZyij9iRv6sGqLRdTPkY69YX6+7wvVGmsdBbiIfN/8OdsI7HABjvEok6ZopQ=="
		        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>


		<!-- include libraries(jQuery, bootstrap) -->
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">

		<!-- include summernote css/js -->
		<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>

		<!-- 공통 헤더 적용 첨부 -->
		<link rel="stylesheet" href="/static/admin/css/header.css"/>
		<link rel="preconnect" href="https://fonts.googleapis.com"/>
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
		<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
		      rel="stylesheet">

		<title>스쿨 메인페이지</title>

		<script src="https://kit.fontawesome.com/ee5cb5f44c.js" crossorigin="anonymous"></script>
</head>

<body>

<div data-th-replace="header :: header"></div>

<h1>스쿨 회원 리스트</h1>

<table class="table table-bordered">
		<thread>
				<tr>
						<th>회원명</th>
						<th>프로필 사진</th>
						<th>회원 등급</th>
				</tr>
		</thread>

		<tbody>
		<tr data-th-each="schoolUser : ${schoolUsers}" data-th-object="${schoolUser}">
				<td data-th-text="*{writer.nickname}">작성자</td>
				<td data-th-text="*{writer.photo}">사진</td>
				<td data-th-text="*{level.levelName}">회원 등급</td>
		</tr>
		</tbody>
</table>

<br/>
<br/>

<h1>스쿨 게시글 리스트</h1>
<!-- 검색창-->
<form action="/post/search" method="post">
		<div>
				<select name="filter">
						<option value="0">내용</option>
						<option value="1">작성자</option>
				</select>
				<input name="keyword" type="text" placeholder="검색어를 입력하세요."/>
				<input id="schoolNo" name="schoolNo" type="hidden" value="1"/><!-- schoolNo를 Integer로 선언 -->
				<button id="postSearchForm">검색</button>
		</div>
</form>

<div id="searchResult">
		<!-- 검색 결과가 여기에 표시될 것입니다 -->
</div>


<div class="container">
		<div class="row" style="width: 100px">
				<div class="col-md-2">
				</div>
				<div class="col-md-8" style="text-align:center;" id="">
						<div id="post_setting" onclick="postForm()" style="width: 120px">
								<button>새 글 작성</button>
						</div>
				</div>
		</div>
</div>

<div data-th-replace="post/postModal/form :: postAdd-modal">새 글 작성</div>

<table class="table table-bordered" style="width: 555px">
		<thread>
				<tr>
						<th>닉네임</th>
						<th>사진</th>
						<th>내용</th>
						<th>작성일</th>
						<th>...(설정)</th>
				</tr>
		</thread>
		<tbody>
		<tr class="postItem" data-th-each="post : ${postList}" data-th-object="${post}">
				<!--				해당 게시글의 no를 가져오는지 확인하기위해 히든으로 처리-->
				<td class="postNo" data-th-text="*{no}" hidden></td>
				<td data-th-text="*{writer.nickname}">닉네임</td>
				<td data-th-text="*{writer.photo}">사진</td>
				<td>
						<a data-th-href="@{'view/' + *{schoolNo}(no=*{no})}" data-th-utext="*{content}">내용</a>
				</td>
				<td data-th-text="${#dates.format(post.createdAt,'yyyy-MM-dd')}">작성일</td>

				<td>
						<div class="dropdown">
								<button class="btn btn-secondary settingBtn" type="button" data-bs-toggle="dropdown"
								        aria-expanded="false">...
								</button>

								<div class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="display: block;width: 100px;">
										<div class="container">
												<div class="row" style="width: 100px;">
														<div id="post_md" onclick="postMd()" style="width: 110px;">글 수정
														</div>
												</div>

												<div data-th-replace="post/postModal/md :: postMd-modal">글 수정</div>
										</div>

										<div>
												<a id="delete" data-th-href="@{delete(schoolNo=*{schoolNo}, post_no=${post.no})}"
												   class="dropdown-item">삭제</a>
										</div>

										<div>
												<a id="copyLinkButton" class="dropdown-item">주소 복사</a>
										</div>
										<div>
												<a id="report" class="dropdown-item">게시글 신고</a>
										</div>
										<div>
												<label for="gradeMd" id="gradeMdLabel" style="display: none">공지로 등록</label>
												<input type="checkbox" id="gradeMd" name="post" value="1" style="display: none"/>
										</div>
								</div>
						</div>
				</td>
		</tr>
		</tbody>
</table>


<!-- 설정을 눌렀을 때 드롭다운이 나타나도록 -->
<script>
		$(document).ready(function() {
				// ... 버튼을 클릭할 때 드롭다운 메뉴의 가시성을 토글합니다.
				$(".settingBtn").click(function() {
						$(this).next(".dropdown-menu").toggle();
				});
		});
</script>

<script>
		$(document).ready(function() {
				// 모든 드롭다운 메뉴를 숨깁니다.
				$(".dropdown-menu").hide();

				// 클래스를 가진 settingBtn 버튼을 클릭할 때 드롭다운 메뉴의 가시성을 토글합니다.
				$(".settingBtn").click(function() {
						// 모든 드롭다운 메뉴를 숨깁니다.
						$(".dropdown-menu").hide();

						// 클릭된 버튼 다음에 오는 드롭다운 메뉴를 찾아 가시성을 토글합니다.
						$(this).next(".dropdown-menu").toggle();

						// 클릭된 버튼 이외의 부분을 클릭할 때 드롭다운 메뉴를 숨깁니다.
						$(document).on("click", function(event){
								if(!$(event.target).closest(".dropdown").length) {
										$(".dropdown-menu").hide();
								}
						});
				});
		});
</script>


<!--스쿨에 가입하지 않은 유저 가입하기 처리-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.12.1/qs.min.js"
        integrity="sha512-vuLOE4Fh9lfxaN9n81Vl1HwrqMYz9WKoNmsHNC7Hz7OWX4k4O7FjCyQ1tQ82RJExao+Fas40RLiS5PCfVRGgnQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
		// 문서가 로드되면 실행될 함수
		$(document).ready(function() {
				$("#joinButton").click(function() {
						const searchParam = window.location.search.replace("?", "");
						const { schoolNo } = window.Qs.parse(searchParam);
						join(schoolNo);
				});
		});

		function join(schoolNo) {
				$.ajax({
						type: "POST",
						url: "/user/userNo",
						success: function(response) {
								const loginUser = response.no;
								if (!loginUser) {
										console.error("로그인한 사용자 정보가 없습니다.");
										return;
								}
								const userNo = loginUser.no;
								console.log("@@@@@@@==>" + userNo);
								addSchoolUser(userNo, schoolNo);
						},
						error: function(xhr, status, error) {
								console.error("사용자 정보 요청 실패:", error);
								alert("사용자 정보를 가져오지 못했습니다. 다시 시도해주세요.");
						},
				});
		}

		function addSchoolUser(userNo, schoolNo) {
				$.ajax({
						type: "POST",
						url: "/schoolUser/addSchoolUser",
						contentType: "application/json",
						data: JSON.stringify({
								userNo: userNo,
								schoolNo: schoolNo,
						}),
						success: function(response) {
								alert("가입이 완료되었습니다.");
								console.log("사용자 가입 성공");
						},
						error: function(xhr, status, error) {
								alert("가입에 실패했습니다. 다시 시도해 주세요.");
								console.error("가입 요청 실패:", error);
						},
				});
		}
</script>

<!-- 게시글 주소 복사 버튼 -->
<script>
		$(document).ready(function() {
				$('#copyLinkButton').click(function() {
						var url = window.location.href;
						var tempInput = document.createElement('input');
						tempInput.value = url;
						document.body.appendChild(tempInput);
						tempInput.select();
						document.execCommand('copy');
						document.body.removeChild(tempInput);
						alert('게시글 주소가 복사되었습니다.');
				});
		});
</script>

<!-- 폼 서브밋 -->
<script>
		$(document).ready(function() {
				$("#postSearchForm").submit(function(event) {
						event.preventDefault();
						var content = $("input[name='keyword']").val();
						var filter = $("select[name='filter']").val();
						var schoolNo = $("input[name='schoolNo']").val();
						$.ajax({
								type: "GET",
								url: "/post/search",
								data: {
										schoolNo: schoolNo,
										keyword: content,
										filter: filter
								},
								success: function(response) {
										$("#searchResult").html(response);
								},
								error: function(xhr, status, error) {
										console.error("검색 요청 실패:", error);
								}
						});
				});
		});
</script>
</body>

</html>
