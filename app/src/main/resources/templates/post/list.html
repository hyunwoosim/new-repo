<!DOCTYPE html>
<html
				lang="en"
				xmlns:th="http://www.w3.org/1999/xhtml"
				xmlns:sec="http://www.w3.org/1999/xhtml"
>
<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

		<!--	공통 헤더 적용 첨부	-->
		<link rel="stylesheet" href="/static/admin/css/header.css"/>
		<link rel="preconnect" href="https://fonts.googleapis.com"/>
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
		<link
						href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
						rel="stylesheet">

		<!-- 모달 사용 첨부 -->
		<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
					integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
		<script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
						src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>


		<title>스쿨 메인페이지</title>

		<script
						src="https://kit.fontawesome.com/ee5cb5f44c.js"
						crossorigin="anonymous"
		></script>
</head>
<body>

<div data-th-replace="header :: header"></div>

<h1>스쿨 회원 리스트</h1>

<table class="table table-bordered">
		<thread>
				<tr>
						<th>회원명</th>
						<th>프로필 사진</th>
						<th>회원 등급</th>
				</tr>
		</thread>

		<tbody>
		<tr
						data-th-each="schoolUser : ${schoolUsers}"
						data-th-object="${schoolUser}"
		>
				<td data-th-text="*{writer.nickname}">작성자</td>
				<td data-th-text="*{writer.photo}">사진</td>
				<td data-th-text="*{level.levelName}">회원 등급</td>
		</tr>
		</tbody>
</table>

<br/>
<br/>

<h1>스쿨 게시글 리스트</h1>
<!-- 검색창-->
<form action="/post/search" method="post">
		<div>
				<select name="filter">
						<option value="0">내용</option>
						<option value="1">작성자</option>
				</select>
				<input name="keyword" type="text" placeholder="검색어를 입력하세요."/>
				<input
								name="schoolNo"
								type="hidden"
								value="1"
				/><!-- schoolNo를 Integer로 선언 -->
				<!--                <input th:if="${schoolNo != null}" name="schoolNo" type="hidden" th:value="${schoolNo}">&lt;!&ndash; schoolNo를 Integer로 선언 &ndash;&gt;-->
				<button id="postSearchForm">검색</button>
		</div>
</form>


<script
				src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"
>
		$(document).ready(function() {
				// 폼이 제출되었을 때의 동작 설정
				$("#postSearchForm").submit(function(event) {
						// 폼의 기본 동작인 페이지 리로드를 막습니다.
						event.preventDefault();

						// 입력된 content를 가져옵니다.
						var content = $("input[name='keyword']").val();
						var filter = $("select[name='filter']").val();
						var schoolNo = $("input[name='schoolNo']").val();

						// 서버에 검색 요청을 보냅니다.
						$.ajax({
								type: "GET",
								url: "/post/search", // 검색을 처리할 서버의 엔드포인트
								data: {
										schoolNo: schoolNo,
										keyword: content,
										filter: filter}, // 검색어를 전달합니다.
								success: function(response) {
										// 검색 결과를 받아와서 HTML로 표시합니다.
										$("#searchResult").html(response);
								},
								error: function(xhr, status, error) {
										console.error("검색 요청 실패:", error);
								}
						});
				});
		});
</script>

<div id="searchResult">
		<!-- 검색 결과가 여기에 표시될 것입니다 -->
</div>

<th:block th:if="${schoolUser}">
		<a data-th-href="@{form(schoolNo=*{schoolNo})}" href="form.html">새 글</a>
</th:block>
<th:block th:unless="${schoolUser}">
		<button id="joinButton">가입하기</button>
</th:block>

<table class="table table-bordered">
		<thread>
				<tr>
						<th>닉네임</th>
						<th>사진</th>
						<th>내용</th>
						<th>작성일</th>
						<th>...(설정)</th>
				</tr>
		</thread>
		<tbody>
		<tr data-th-each="post : ${postList}" data-th-object="${post}">
				<td data-th-text="*{writer.nickname}">닉네임</td>
				<td data-th-text="*{writer.photo}">사진</td>
				<td>
						<a
										data-th-href="@{'view/' + *{schoolNo}(no=*{no})}"
										th:utext="*{content}"
						>내용</a
						>
				</td>
				<td data-th-text="${#dates.format(post.createdAt,'yyyy-MM-dd')}">
						작성일
				</td>

				<!--				<td>-->
				<!--            <a data-th-href="@{md(no=*{no}, schoolNo=*{schoolNo})}"-->
				<!--              href="md.html?(no=*{no}, schoolNo=*{schoolNo})">설정</a>-->
				<!--          </td>-->
				<td>
						<div class="dropdown">
								<button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
												data-bs-toggle="dropdown" aria-expanded="false">
										...
								</button>
								<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
										<li>
												<button id="md" type="button" class="dropdown-item">글 수정</button>
										</li>
										<li>
												<button id="delete" type="button" class="dropdown-item">글 삭제</button>
										</li>
										<!--<li><a class="dropdown-item" data-th-href="@{delete(schoolNo=*{schoolNo}, post_no=${post.no})}">[삭제]</a></li>-->
										<li>
												<button id="copyLinkButton" type="button" class="dropdown-item">주소 복사</button>
										</li>
										<li>
												<button id="report" type="button" class="dropdown-item">게시글 신고</button>
										</li>
										<li><label for="gradeMd" id="gradeMdLabel" style="display: none" class="dropdown-item">공지로
												등록</label></li>
										<li><input type="checkbox" id="gradeMd" name="post" value="1" style="display: none"/></li>
										<li>
												<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">닫기</button>
										</li>
								</ul>
						</div>
				</td>

				<!--스쿨에 가입하지 않은 유저 가입하기 처리-->
				<script
								src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.12.1/qs.min.js"
								integrity="sha512-vuLOE4Fh9lfxaN9n81Vl1HwrqMYz9WKoNmsHNC7Hz7OWX4k4O7FjCyQ1tQ82RJExao+Fas40RLiS5PCfVRGgnQ=="
								crossorigin="anonymous"
								referrerpolicy="no-referrer"
				></script>
				<script>

						// 문서가 로드되면 실행될 함수
						$(document).ready(function () {
								//        $("#header").load("/templates/header.html");
								// 가입하기 버튼에 이벤트 리스너 추가
								$("#joinButton").click(function () {
										const searchParam = window.location.search.replace("?", "");
										const { schoolNo } = window.Qs.parse(searchParam);
										join(schoolNo); // 가입 처리 함수 호출
								});
						});

						// 사용자 가입 처리 함수
						function join(schoolNo) {
								// 서버로 사용자 가입 요청을 보냅니다.
								$.ajax({
										type: "POST", // 또는 GET, 서버의 요청 방식에 따라 변경할 수 있습니다.
										url: "/user/userNo", // 사용자 정보를 가져오는 엔드포인트를 호출합니다.
										//            data: { user_no: userNo }, // 실제 user_no 값을 123 대신에 입력하세요
										success: function (response) {
												const loginUser = response.no; // 변경된 사용자 정보 필드에 맞게 수정
												if (!loginUser) {
														console.error("로그인한 사용자 정보가 없습니다.");
														return;
												}
												const userNo = loginUser.no;
												console.log("@@@@@@@==>" + userNo);
												// 가입 처리 함수 호출
												// 사용자 번호를 user_no라는 파라미터로 전달할 수 있습니다.
												// 이 부분을 서버 코드에서 해당하는 로직에 맞게 수정해야 합니다.
												addSchoolUser(userNo, schoolNo);
										},
										error: function (xhr, status, error) {
												console.error("사용자 정보 요청 실패:", error);
												alert("사용자 정보를 가져오지 못했습니다. 다시 시도해주세요.");
										},
								});
						}

						// 스쿨에 가입하는 함수
						function addSchoolUser(userNo, schoolNo) {
								// 서버로 사용자 가입 요청을 보냅니다.
								$.ajax({
										type: "POST", // 또는 GET, 서버의 요청 방식에 따라 변경할 수 있습니다.
										url: "/schoolUser/addSchoolUser", // 스쿨에 가입하는 엔드포인트를 호출합니다.
										contentType: "application/json", // 요청 헤더의 Content-Type을 JSON으로 설정
										data: JSON.stringify({
												// 데이터를 JSON 형식으로 변환하여 전송
												userNo: userNo,
												schoolNo: schoolNo,
										}),
										success: function (response) {
												// 가입이 성공한 경우의 동작을 여기에 추가합니다.
												alert("가입이 완료되었습니다.");
												console.log("사용자 가입 성공");
										},
										error: function (xhr, status, error) {
												// 가입이 실패한 경우의 동작을 여기에 추가합니다.
												alert("가입에 실패했습니다. 다시 시도해 주세요.");
												console.error("가입 요청 실패:", error);
										},
								});
						}
				</script>

				<script>
						$(document).ready(function () {
								// 게시글 주소 복사 버튼 클릭 이벤트
								$('#copyLinkButton').click(function () {
										// 현재 페이지의 URL을 가져와 복사합니다.
										var url = window.location.href;
										// 클립보드에 복사할 텍스트를 생성합니다.
										var tempInput = document.createElement('input');
										tempInput.value = url;
										document.body.appendChild(tempInput);
										tempInput.select();
										document.execCommand('copy');
										document.body.removeChild(tempInput);
										// 복사가 완료되었다는 메시지를 출력합니다.
										alert('게시글 주소가 복사되었습니다.');
								});

								function deletePost(post_no, schoolNo) {
										if (confirm('정말로 삭제하시겠습니까?')) {
												// 삭제 요청을 보내는 로직을 추가하세요
												// 예를 들어, AJAX 요청을 사용하여 서버에 삭제를 요청할 수 있습니다.
												// 여기서는 폼을 서브밋하는 예시를 들겠습니다.
												$.ajax({
														type: 'GET',
														url: '/delete', // 삭제 요청을 보낼 URL을 여기에 입력하세요.
														data: {
																post_no: post.no,
																schoolNo: post.schoolNo,
														},
														success: function (response) {
																// 삭제가 성공적으로 처리되면 원하는 동작을 수행하세요.
																// 예를 들어, 페이지 새로고침 등을 수행할 수 있습니다.
																location.reload();
														},
														error: function (xhr, status, error) {
																// 삭제 요청이 실패한 경우 처리할 로직을 여기에 작성하세요.
																console.error(xhr.responseText);
														},
												});
										}
								}

								// 서버에서 사용자의 등급 정보를 전달합니다.
								var userGrade = '${userGrade}'; // "매니저" 또는 "부매니저"를 나타내는 값

								// "매니저" 또는 "부매니저"인 경우 체크박스를 보이도록 설정
								if (userGrade === 'admin' || userGrade === 'sub-admin') {
										$('#gradeMd').show();
										$('#gradeMdLabel').show();
								}
						});
				</script>
</body>
</html>
